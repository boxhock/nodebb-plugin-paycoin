"use strict";

var 	db = require('./nodebb').db,
	nconf = require('nconf');

module.exports = function(Plugin) {
	// filter:user.settings
	Plugin.addUserSettings = function(settings, callback) {
		// todo: use settings.tpl instead
		settings.push({
			title: "Reddcoin Tip Settings",
			content: "<label>Reddcoin Address</label><input type='text' data-property='address' placeholder='e.g RnrvzUnhxxbaYwqivWcis7fJeCLhkZCyQ7' class='form-control' />"
		});

		callback(null, settings);
	};

	// filter:user.getSettings
	Plugin.getUserSettings = function(data, callback) {
			// Temp console to check results			
			//console.log(' Gett Settings', data);
			db.getObjectField('user:' + data.uid + ':settings', 'nodebb-plugin-reddcoin:address', function(err, title) {
			if (err) {
				callback(err);
			}
	
			data.settings.address = title;
			callback(null, data);
		});	
	};
	
	// action:user.saveSettings
	Plugin.saveUserSettings = function(data) {
		console.log(' Save Settings');

		if (data.uid) {
			// Temp console to check results			
			//console.log(' Somethign to Save', data.uid);			
			

			if (data.settings.address) {
			console.log(' Somethign to Save', data.settings.address);
			db.setObjectField('user:' + data.uid + ':settings', 'nodebb-plugin-reddcoin:address', data.settings.address);
			}else{
			// else field empty
			// Temp console to check results			
			//console.log(' Somethign to Save empty', data.settings.address);
			db.setObjectField('user:' + data.uid + ':settings', 'nodebb-plugin-reddcoin:address', '');
		
			}

		}
	};
	
	// filter:post.posts.custom_profile_info
	Plugin.addProfileInfo = function(profileInfo, callback) {

		db.getObjectField('user:' + profileInfo.uid + ':settings', 'nodebb-plugin-reddcoin:address', function(err, address){

		db.getObjectField('user:' + profileInfo.uid, 'username', function(err, username){

		console.log('Profile User Settings', username);

			profileInfo.profile.push({
				content: "<span class='tipping-link'><a href='reddcoin:" + address + "?label=Tip%20To%20" + username + "' title='Tip Gnasher with Reddcoin'><img src='" + nconf.get('url') + "/images/rdd_icon.png'> Tip " + username + "</a></span>"
			});
		});
		callback(err, profileInfo);

		});
	};
		

};
